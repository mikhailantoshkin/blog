<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Mikhail Antoshkin" />
  <meta itemprop="description" content="" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://mikhailantoshkin.github.io/blog/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://mikhailantoshkin.github.io/blog/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://mikhailantoshkin.github.io/blog/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://mikhailantoshkin.github.io/blog/favicon.ico"
  />
  <link rel="stylesheet" href="https://mikhailantoshkin.github.io/blog/style.css"/>
  
  <title>Local dev environment with LDAP server for pain and suffering</title>
  

  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;mikhailantoshkin.github.io&#x2F;blog">Home</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://mikhailantoshkin.github.io/blog/posts">Posts</a>
        
        <a href="https://mikhailantoshkin.github.io/blog/resume">Resume</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;twitter.com&#x2F;mike_antoshkin" target="_blank" rel="noopener me"
   title="twitter">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;github.com&#x2F;mikhailantoshkin" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;mikhail-antoshkin&#x2F;" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="mike.antoshkin@gmail.com" target="_blank" rel="noopener me"
   title="email">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://mikhailantoshkin.github.io/blog/posts">Posts</a></li>
    
    <li><a href="https://mikhailantoshkin.github.io/blog/resume">Resume</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>May 11, 2025</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  4 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>Local dev environment with LDAP server for pain and suffering</h1>
	</header>

	<div class="content">
        
	  <p>At my previous workplace, we had a very specific DX problem to solve: we had a pool of shared VMs
used for testing. When you wanted to test out your PR you could grab a VM from the pool and
deploy your changes there. At some point, after a few QA engineers overwrote each other's VMs a few times,
we decided to write something that would allow you to "lease" the VM.
The first iteration of this was a simple Telegram bot. User experience was a bit lacking, but it got the job done.</p>
<p>But one day, frustrated by the clunkiness of the solution, my colleague and I decided that the time
for a makeover had come. After a brainstorming session, we ended up with a short list of what we wanted from this system.
The three main points for it were:</p>
<ul>
<li>It needs to be a website (no more clunky messaging app interfaces)</li>
<li>It needs to integrate with the company AD setup for auth</li>
<li>It needs to be written in Rust</li>
</ul>
<p>Easy enough, we already have experience with all of these, so this should not be a problem.
After a few evenings of hacking, the clunky Telegram bot was reborn as <a href="https://github.com/udv-group/tachikoma">tachikoma</a>.</p>
<p>More and more people started to use it, and after a while, we got a request to add the ability to assign VMs to a specific team.
Our junky at the time auth solution didn't cut it anymore - we now had to grab information about the groups the users are a part of.</p>
<p>At the time dev setup for LDAP was borrowed from <a href="https://github.com/inejge/ldap3/tree/00a513ece4ffa9a9782860c285f4c4c12bc07552/data">ldap3 crate examples</a>.
With how our auth was set up, you could log in with empty credentials, very nice for dev environment.
But now we had to query the user from the LDAP server, and this example setup would not cut it anymore.
As any reasonable dev would do, we just ran all requests against a real AD server on the company infra.
This meant that you had to have a VPN enabled when you were doing local development, but such is life.</p>
<p>Fast forward half a year or so, and I have now changed companies (and country of residency) and don't have
easy access to the AD server anymore. Now I had no choice but to add a test LDAP server setup to the project.</p>
<h1 id="ldap">LDAP</h1>
<p>At first, I thought I could just adjust the <code>ldap</code> crate setup and I'd be golden. Not having worked with
LDAP servers before, I got very quickly overwhelmed. It was definitely way too complex for what I needed,
so, a few stackoverflow posts later, I was reading Arch docs of all places to see how to set up an <code>slapd</code>
from scratch.</p>
<p>It netted good progress: I had an initial config that <code>slapd</code> would accept and start.</p>
<p><code>config.ldif</code></p>
<pre data-lang="toml" data-name="config.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="config.ldif"># The root config entry
dn: cn=config
objectClass: olcGlobal
cn: config
olcArgsFile: .ldap&#x2F;run&#x2F;slapd.args
olcPidFile: .ldap&#x2F;run&#x2F;slapd.pid

# Schemas
dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema

include: file:&#x2F;&#x2F;&#x2F;etc&#x2F;openldap&#x2F;schema&#x2F;core.ldif

# The config database
dn: olcDatabase=config,cn=config
objectClass: olcDatabaseConfig
olcDatabase: config
olcRootDN: cn=Manager,dc=example,dc=org

# The database for our entries
dn: olcDatabase=mdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: mdb
olcSuffix: dc=example,dc=org
olcRootDN: cn=Manager,dc=example,dc=org
olcRootPW: test
olcDbDirectory: .ldap&#x2F;db
olcDbIndex: objectClass eq
olcDbIndex: uid pres,eq
olcDbIndex: mail pres,sub,eq
olcDbIndex: cn,sn pres,sub,eq
olcDbIndex: dc eq

# Additional schemas
# RFC1274: Cosine and Internet X.500 schema
include: file:&#x2F;&#x2F;&#x2F;etc&#x2F;openldap&#x2F;schema&#x2F;cosine.ldif
# RFC2307: An Approach for Using LDAP as a Network Information Service
# Check RFC2307bis for nested groups and an auxiliary posixGroup objectClass (way easier)
include: file:&#x2F;&#x2F;&#x2F;etc&#x2F;openldap&#x2F;schema&#x2F;nis.ldif
# RFC2798: Internet Organizational Person
include: file:&#x2F;&#x2F;&#x2F;etc&#x2F;openldap&#x2F;schema&#x2F;inetorgperson.ldif
</code></pre>
<p>A few notes for me from the past:</p>
<ul>
<li><code>olcArgsFile</code> and <code>olcPidFile</code> need to point to an existing directory.
This looks like it was designed with <code>systemd</code> in mind, so if you are using it - you should point it
to <code>unit</code>s <code>run</code> directory.</li>
<li><code>olcDbDirectory</code> is a path to the directory where the main database is going to be stored, so be mindful about access rights.</li>
<li>Take note of what value you used for <code>olcDatabase</code> for entry with <code>objectClass: olcMdbConfig</code>.
This will come into play with later configuration.</li>
<li>Don't forget to set up <code>olcRootDN</code> and <code>olcRootPW</code>, this is your credential for admin access</li>
</ul>
<p>Before applying this configuration, we need to create a base directory structure. In my case,
it's</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">mkdir -p .ldap&#x2F;db .ldap&#x2F;config .ldap&#x2F;run
</code></pre>
<p>Now to apply this configuration, run</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">slapadd -n 0 -F .ldap&#x2F;config -l ldap&#x2F;config.ldif
</code></pre>
<p>where <code>-F</code> is a directory where server configuration is going to be stored and <code>-l</code>
is a path to the configuration file.</p>
<p>The next step is adding some entries, which is also very straightforward:</p>
<p><code>config.ldif</code></p>
<pre data-lang="toml" data-name="init.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="init.ldif"># example.org
dn: dc=example,dc=org
dc: example
o: Example Organization
objectClass: dcObject
objectClass: organization

# Manager, example.org
dn: cn=Manager,dc=example,dc=org
cn: Manager
description: LDAP administrator
objectClass: organizationalRole
objectClass: top
roleOccupant: dc=example,dc=org

# People, example.org
dn: ou=People,dc=example,dc=org
ou: People
objectClass: top
objectClass: organizationalUnit

# Groups, example.org
dn: ou=Group,dc=example,dc=org
ou: Group
objectClass: top
objectClass: organizationalUnit
</code></pre>
<p>To apply this, you first would need to start up the <code>slapd</code> daemon:</p>
<pre><code>slapd -h ldapi:&#x2F;&#x2F;ldapi -F .ldap&#x2F;config
</code></pre>
<p>After a second, you can add the base entries with</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;init.ldif
</code></pre>
<p>Note the <code>-D</code> and <code>-w</code> arguments - this is your credentials you've set up when configuring the server.</p>
<p>Now we are ready to add a user and a group! This config defines a user and a group he is a part of.</p>
<p><code>user.ldif</code></p>
<pre data-lang="toml" data-name="user.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="user.ldif">dn: uid=johndoe,ou=People,dc=example,dc=org
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: johndoe
cn: John Doe
sn: Doe
givenName: John
title: Guinea Pig
telephoneNumber: +0 000 000 0000
mobile: +0 000 000 0000
postalAddress: AddressLine1$AddressLine2$AddressLine3
userPassword: test
labeledURI: https:&#x2F;&#x2F;archlinux.org&#x2F;
loginShell: &#x2F;bin&#x2F;bash
uidNumber: 9999
gidNumber: 9999
homeDirectory: &#x2F;home&#x2F;johndoe&#x2F;
mail: jdoe@example.org
description: This is an example user

dn: cn=joe,ou=Group,dc=example,dc=org
objectClass: groupOfNames
objectClass: top
cn: joe
member: uid=johndoe,ou=People,dc=example,dc=org
</code></pre>
<p>To apply it, run</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;user.ldif
</code></pre>
<p>At this point I'm feeling pretty good: I have a working LDAP server with a user and a group.
Time to test the setup! Oh... User is missing <code>memberOf</code> property?</p>
<h1 id="memberof">memberOf</h1>
<p>Remember that we needed to grab the information about the groups the user is a member of?
This is done with <code>memberOf</code> attribute on the user. But when I query a user in does not have
such an attribute, though he is definitely a member of a group, so what is going on?</p>
<p>As it turns out, there is a so-called "overlay" that back-populates users with <code>memberOf</code>
attributes. And we have to enable it somehow.</p>
<p>Either Google is now useless, or there are no sane examples on how to do it (I suspect both),
but after a few hours of delirium, I ended up with these three config files. Don't ask me what
they do, I won't be able to answer that, I just know that they work and won't steal your crypto (probably).</p>
<p><code>overlay.ldif</code></p>
<pre data-lang="toml" data-name="overlay.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="overlay.ldif"># enable memberOf overlay, so infomation about user groups
# can be queried from the user
dn: cn=module,cn=config
cn: module
objectClass: olcModuleList
olcModuleLoad: memberof

dn: olcOverlay={0}memberof,olcDatabase={1}mdb,cn=config
objectClass: olcConfig
objectClass: olcMemberOf
objectClass: olcOverlayConfig
objectClass: top
olcOverlay: memberof
olcMemberOfDangling: ignore
olcMemberOfRefInt: TRUE
olcMemberOfGroupOC: groupOfNames
olcMemberOfMemberAD: member
olcMemberOfMemberOfAD: memberOf
</code></pre>
<p><code>refint.ldif</code></p>
<pre data-lang="toml" data-name="refint.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="refint.ldif">dn: cn=module{0},cn=config
changetype: modify
add: olcmoduleload
olcmoduleload: refint
</code></pre>
<p><code>refint2.ldif</code></p>
<pre data-lang="toml" data-name="refint2.ldif" class="language-toml "><code class="language-toml" data-lang="toml" data-name="refint2.ldif">dn: olcOverlay={1}refint,olcDatabase={1}mdb,cn=config
objectClass: olcConfig
objectClass: olcOverlayConfig
objectClass: olcRefintConfig
objectClass: top
olcOverlay: {1}refint
olcRefintAttribute: memberof member manager owner
</code></pre>
<p>If you apply these configs <em>before</em> you add the user - you would have a <code>memberOf</code>
attribute for a user, that is a part of a group with <code>objectClass: groupOfNames</code>.</p>
<p>So the script to set it all up in one go looks like this:</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">#!&#x2F;usr&#x2F;bin&#x2F;env bash

mkdir -p .ldap&#x2F;db .ldap&#x2F;config .ldap&#x2F;run
slapadd -n 0 -F .ldap&#x2F;config -l ldap&#x2F;config.ldif
slapd -h ldapi:&#x2F;&#x2F;ldapi -F .ldap&#x2F;config
sleep 1
ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;init.ldif
ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;overlay.ldif
ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;refint.ldif
ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;refint2.ldif
ldapadd -x -D &#x27;cn=Manager,dc=example,dc=org&#x27; -w test -H ldapi:&#x2F;&#x2F;ldapi -f ldap&#x2F;user.ldif
</code></pre>
<h1 id="morale-of-the-story">Morale of the story</h1>
<p>There is none.
LDAP is a spawn of satan.
For how ubiquitous it is - it's baffling how hard it is to find a good example configuration.
Half of the time, I was just hitting digital rocks together.</p>
<p>Props to Arch docs, it again proves to be the GOAT.</p>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>977 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2025-05-11</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2025 <a href="https:&#x2F;&#x2F;mikhailantoshkin.github.io&#x2F;blog">Mikhail Antoshkin</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
  </p>
</footer>




	</div>
	
	<script src="https://mikhailantoshkin.github.io/blog/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    
		<link href="https://unpkg.com/highlightjs-badge/highlightjs/styles/vs2015.css" rel="stylesheet">
		<!-- https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.1/build/styles/  for min version -->
		<script src="https://unpkg.com/highlightjs-badge/highlightjs/highlight.pack.js"></script>
		<script src="https://unpkg.com/highlightjs-badge/highlightjs-badge.min.js"></script>
		<script>
			var pres = document.querySelectorAll("pre>code");
			for (var i = 0; i < pres.length; i++) {
				hljs.highlightBlock(pres[i]);
			}
		</script>
		
			<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
			<script>
				var options = {
					copyIconClass: "gg-clipboard",
					checkIconClass: "gg-check"
				};
				window.highlightJsBadge(options);
			</script>
		

	

	
	<script src="https://mikhailantoshkin.github.io/blog/js/main.js"></script>

    
    

	
  </body>
</html>
